{{ define "main" }}

<div class="sidebar">
  {{ if or (gt .WordCount 200) .Params.Toc }}
  <section class="toc">
    <h2>Table Of Contents</h2>
    {{ .TableOfContents }}
  </section>
  {{ end }}
</div>

<article>
  <div class="metadata">
    <h1>{{ .Title }}</h1>
    {{ $dateMachine := .Date | time.Format "2006-01-02T15:04:05-07:00" }}
    {{ $dateHuman := .Date | time.Format ":date_long" }}
    <time datetime="{{ $dateMachine }}">{{ $dateHuman }}</time>

    <div class="taxonomy">
      <!-- Categories -->
      {{ with .Params.Categories }}
      <span id="post-categories">
        <ul>
          <li><strong>Categories</strong>:&nbsp;</li>
          {{ range . }}
          <li class="category-item"><a href="{{ $.Site.BaseURL }}categories/{{ . | urlize }}">{{ . }}</a> </li>
          {{ end }}
        </ul>
      </span>
      {{ end }}

      <!-- Tags -->
      {{ with .Params.tags }}
      <span id="post-tags">
        <ul>
          <li><strong>Tags</strong>:&nbsp;</li>
          {{ range . }}
          <li class="tag-item"><a href="{{ $.Site.BaseURL }}tags/{{ . | urlize }}"><em>{{ . }}</em></a> </li>
          {{ end }}
        </ul>
      </span>
      {{ end }}
    </div>
  </div>

  {{ .Content }}
  
  <div id="react-single-actions" data-post-id="{{ .File.UniqueID }}"></div>
</article>

<script type="module">
// 平滑滚动与滚动侦测高亮
const toc = document.querySelector('#TableOfContents');
if (toc) {
  // 点击目录时平滑滚动（默认已启用，但兼容旧浏览器）
  toc.addEventListener('click', (e) => {
    const a = e.target.closest('a');
    if (!a) return;
    const id = a.getAttribute('href')?.replace('#','');
    const target = id ? document.getElementById(id) : null;
    if (target) {
      e.preventDefault();
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      history.replaceState(null, '', `#${id}`);
    }
  });

  // 滚动时根据当前可见标题高亮 TOC
  const headings = Array.from(document.querySelectorAll('article h1, article h2, article h3, article h4'));
  const linkMap = new Map();
  for (const a of toc.querySelectorAll('a[href^="#"]')) {
    const id = a.getAttribute('href').slice(1);
    linkMap.set(id, a);
  }

  const setActive = (id) => {
    for (const a of linkMap.values()) a.classList.remove('is-active');
    const active = linkMap.get(id);
    if (active) active.classList.add('is-active');
  };

  const observer = new IntersectionObserver((entries) => {
    // 选择进入视口且最靠上的标题
    const visible = entries
      .filter(e => e.isIntersecting)
      .sort((a, b) => a.target.getBoundingClientRect().top - b.target.getBoundingClientRect().top);
    if (visible.length) {
      const id = visible[0].target.id;
      if (id) setActive(id);
    }
  }, {
    root: null,
    rootMargin: '-96px 0px -60% 0px', // 顶部偏移与下边界，调节高亮时机
    threshold: [0, 1e-3, 0.25]
  });

  headings.forEach(h => {
    // 确保每个标题都有 id（Hugo 通常会生成）
    if (!h.id) {
      h.id = h.textContent.trim().toLowerCase().replace(/\s+/g, '-');
    }
    observer.observe(h);
  });

  // 页面载入后，如果有 hash，滚动到对应标题
  if (location.hash) {
    const target = document.getElementById(location.hash.slice(1));
    if (target) {
      setTimeout(() => target.scrollIntoView({ behavior: 'smooth', block: 'start' }), 0);
    }
  }
}
</script>

<script type="module" src="/react/page.bundle.js"></script>
{{ end }}